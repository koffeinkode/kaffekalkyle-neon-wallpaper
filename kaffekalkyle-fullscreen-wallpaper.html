<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaffekalkyle Purple Psychedelic Wallpaper</title>
    <style>
        @font-face {
            font-family: 'Sporting Grotesque';
            src: url('./SportingGrotesque-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a0033, #330066, #4a0080);
            overflow: hidden;
            font-family: 'Sporting Grotesque', 'Arial', sans-serif;
            cursor: none;
            height: 100vh;
        }

        .psychedelic-coffee-animation {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: radial-gradient(ellipse at center, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.1) 40%, rgba(45, 55, 72, 0.05) 100%);
        }

        /* B√∏lgelager - fullscreen versjon */
        .wave-layer {
            position: absolute;
            width: 150%;
            height: 150%;
            top: -25%;
            left: -25%;
            border-radius: 50%;
            opacity: 0.4;
            animation: waveFlow 20s linear infinite;
        }

        .wave-1 {
            background: radial-gradient(circle, transparent 20%, rgba(102, 126, 234, 0.8) 35%, transparent 50%);
            animation-duration: 25s;
            animation-direction: normal;
        }

        .wave-2 {
            background: radial-gradient(circle, transparent 15%, rgba(118, 75, 162, 0.6) 30%, transparent 45%);
            animation-duration: 32s;
            animation-direction: reverse;
        }

        .wave-3 {
            background: radial-gradient(circle, transparent 25%, rgba(167, 139, 250, 0.7) 40%, transparent 60%);
            animation-duration: 28s;
            animation-direction: normal;
        }

        .wave-4 {
            background: radial-gradient(circle, transparent 18%, rgba(74, 85, 104, 0.5) 35%, transparent 55%);
            animation-duration: 35s;
            animation-direction: reverse;
        }

        @keyframes waveFlow {
            0% { transform: rotate(0deg) scale(0.8); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1.3); }
            75% { transform: rotate(270deg) scale(1.0); }
            100% { transform: rotate(360deg) scale(0.8); }
        }

        /* Fallende kaffeb√∏nner med dybde */
        .floating-bean {
            position: fixed;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 50%, #a78bfa 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: fallDown linear infinite;
            box-shadow: 0 0 30px rgba(167, 139, 250, 0.6);
        }

        .floating-bean::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 70%;
            background: #2d3748;
            border-radius: 2px;
        }

        /* Depth layers - close to far */
        .bean-close {
            width: 60px;
            height: 90px;
            opacity: 1;
            filter: blur(0px);
            z-index: 30;
        }
        
        .bean-medium {
            width: 40px;
            height: 60px;
            opacity: 0.8;
            filter: blur(0.5px);
            z-index: 20;
        }
        
        .bean-far {
            width: 25px;
            height: 37px;
            opacity: 0.5;
            filter: blur(1.5px);
            z-index: 10;
        }
        
        .bean-distant {
            width: 15px;
            height: 22px;
            opacity: 0.3;
            filter: blur(2.5px);
            z-index: 5;
        }

        .bean-1 { left: 5%; animation-duration: 12s; animation-delay: 0s; }
        .bean-2 { left: 85%; animation-duration: 16s; animation-delay: 2s; }
        .bean-3 { left: 15%; animation-duration: 10s; animation-delay: 4s; }
        .bean-4 { left: 60%; animation-duration: 18s; animation-delay: 6s; }
        .bean-5 { left: 75%; animation-duration: 14s; animation-delay: 8s; }
        .bean-6 { left: 25%; animation-duration: 20s; animation-delay: 10s; }
        .bean-7 { left: 90%; animation-duration: 11s; animation-delay: 12s; }
        .bean-8 { left: 50%; animation-duration: 15s; animation-delay: 14s; }
        .bean-9 { left: 30%; animation-duration: 13s; animation-delay: 16s; }
        .bean-10 { left: 70%; animation-duration: 17s; animation-delay: 18s; }
        .bean-11 { left: 10%; animation-duration: 19s; animation-delay: 20s; }
        .bean-12 { left: 80%; animation-duration: 9s; animation-delay: 22s; }

        @keyframes fallDown {
            0% { 
                transform: translateY(-100px) rotate(0deg); 
            }
            100% { 
                transform: translateY(calc(100vh + 100px)) rotate(360deg); 
            }
        }

        /* Spiraler - st√∏rre for fullscreen */
        .spiral {
            position: absolute;
            width: 400px;
            height: 400px;
            border: 4px solid transparent;
            border-radius: 50%;
            animation: spiralSpin 15s linear infinite;
        }

        .spiral-1 {
            top: 15%;
            right: 10%;
            border-top: 4px solid rgba(102, 126, 234, 0.8);
            border-right: 4px solid rgba(118, 75, 162, 0.6);
            animation-duration: 12s;
        }

        .spiral-2 {
            bottom: 15%;
            left: 10%;
            border-bottom: 4px solid rgba(167, 139, 250, 0.7);
            border-left: 4px solid rgba(74, 85, 104, 0.9);
            animation-duration: 18s;
            animation-direction: reverse;
        }

        .spiral-3 {
            top: 50%;
            right: 5%;
            width: 300px;
            height: 300px;
            border-right: 4px solid rgba(102, 126, 234, 0.5);
            border-bottom: 4px solid rgba(167, 139, 250, 0.4);
            animation-duration: 22s;
        }

        @keyframes spiralSpin {
            0% { transform: rotate(0deg) scale(0.8); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1.4); }
            75% { transform: rotate(270deg) scale(1.0); }
            100% { transform: rotate(360deg) scale(0.8); }
        }

        /* Geometrisk damp - st√∏rre effekter */
        .coffee-steam {
            position: absolute;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(167, 139, 250, 0.5) 0%, transparent 70%);
            border-radius: 50%;
            animation: steamRise 12s ease-in-out infinite;
            filter: blur(3px);
        }

        .steam-1 {
            bottom: 25%;
            left: 15%;
            animation-delay: 0s;
        }

        .steam-2 {
            bottom: 35%;
            right: 25%;
            animation-delay: 4s;
        }

        .steam-3 {
            bottom: 15%;
            left: 65%;
            animation-delay: 8s;
        }

        .steam-4 {
            top: 20%;
            left: 30%;
            animation-delay: 2s;
            animation-duration: 14s;
        }

        @keyframes steamRise {
            0% { transform: translateY(0px) scale(0.6); opacity: 0; }
            20% { opacity: 0.8; }
            80% { opacity: 0.6; }
            100% { transform: translateY(-300px) scale(2.0); opacity: 0; }
        }

        /* Kaleidoskop ringer - st√∏rre for fullscreen */
        .kaleidoscope-ring {
            position: absolute;
            border-radius: 50%;
            border: 3px solid transparent;
            animation: kaleidoscopeRotate 20s linear infinite;
            filter: drop-shadow(0 0 20px rgba(167, 139, 250, 0.8));
        }

        .ring-1 {
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            margin: -150px 0 0 -150px;
            border-top: 3px solid rgba(102, 126, 234, 0.9);
            border-bottom: 3px solid rgba(118, 75, 162, 0.7);
            animation-duration: 16s;
            filter: drop-shadow(0 0 25px rgba(102, 126, 234, 0.9)) drop-shadow(0 0 50px rgba(118, 75, 162, 0.7));
        }

        .ring-2 {
            top: 50%;
            left: 50%;
            width: 500px;
            height: 500px;
            margin: -250px 0 0 -250px;
            border-left: 3px solid rgba(167, 139, 250, 0.8);
            border-right: 3px solid rgba(74, 85, 104, 0.6);
            animation-duration: 24s;
            animation-direction: reverse;
            filter: drop-shadow(0 0 30px rgba(167, 139, 250, 0.9)) drop-shadow(0 0 60px rgba(74, 85, 104, 0.6));
        }

        .ring-3 {
            top: 50%;
            left: 50%;
            width: 700px;
            height: 700px;
            margin: -350px 0 0 -350px;
            border-top: 3px solid rgba(45, 55, 72, 0.5);
            border-bottom: 3px solid rgba(102, 126, 234, 0.7);
            animation-duration: 30s;
            filter: drop-shadow(0 0 35px rgba(45, 55, 72, 0.8)) drop-shadow(0 0 70px rgba(102, 126, 234, 0.9));
        }

        @keyframes kaleidoscopeRotate {
            0% { transform: rotate(0deg) scale(0.9); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1.3); }
            75% { transform: rotate(270deg) scale(1.0); }
            100% { transform: rotate(360deg) scale(0.9); }
        }

        /* Pulserende sirkler - st√∏rre effekter */
        .pulsing-circle {
            position: absolute;
            border-radius: 50%;
            animation: pulsate 8s ease-in-out infinite;
        }

        .circle-1 {
            top: 10%;
            left: 10%;
            width: 160px;
            height: 160px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.7) 0%, transparent 70%);
            animation-delay: 0s;
        }

        .circle-2 {
            top: 75%;
            right: 15%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(167, 139, 250, 0.6) 0%, transparent 70%);
            animation-delay: 3s;
        }

        .circle-3 {
            top: 30%;
            right: 30%;
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, rgba(118, 75, 162, 0.8) 0%, transparent 70%);
            animation-delay: 6s;
        }

        @keyframes pulsate {
            0%, 100% { transform: scale(0.8); opacity: 0.6; }
            50% { transform: scale(1.4); opacity: 1; }
        }

        /* Flytende ord - kaffe-relaterte */
        .floating-formula {
            position: absolute;
            color: rgba(167, 139, 250, 0.4);
            font-size: 18px;
            font-weight: normal;
            font-family: 'Sporting Grotesque', 'Arial', sans-serif;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.3), 0 0 20px rgba(102, 126, 234, 0.2);
            animation: floatFormula 20s ease-in-out infinite;
            z-index: 10;
            opacity: 0.6;
            transition: opacity 1.5s ease-in-out, transform 1.2s ease-in-out;
        }

        .formula-1 { top: 8%; left: 15%; animation-delay: 0s; animation-duration: 22s; }
        .formula-2 { top: 25%; right: 20%; animation-delay: 2s; animation-duration: 18s; }
        .formula-3 { bottom: 30%; left: 25%; animation-delay: 4s; animation-duration: 24s; }
        .formula-4 { top: 45%; left: 10%; animation-delay: 6s; animation-duration: 16s; }
        .formula-5 { bottom: 15%; right: 15%; animation-delay: 8s; animation-duration: 26s; }
        .formula-6 { top: 65%; left: 55%; animation-delay: 10s; animation-duration: 20s; }
        .formula-7 { top: 35%; left: 75%; animation-delay: 12s; animation-duration: 19s; }
        .formula-8 { bottom: 45%; left: 45%; animation-delay: 14s; animation-duration: 23s; }
        .formula-9 { top: 15%; right: 35%; animation-delay: 16s; animation-duration: 17s; }
        .formula-10 { bottom: 60%; right: 40%; animation-delay: 18s; animation-duration: 21s; }
        .formula-11 { top: 75%; right: 10%; animation-delay: 20s; animation-duration: 25s; }
        .formula-12 { top: 50%; right: 60%; animation-delay: 22s; animation-duration: 14s; }
        .formula-13 { bottom: 20%; left: 65%; animation-delay: 24s; animation-duration: 27s; }
        .formula-14 { top: 20%; left: 40%; animation-delay: 26s; animation-duration: 15s; }
        .formula-15 { bottom: 35%; right: 25%; animation-delay: 28s; animation-duration: 29s; }

        @keyframes floatFormula {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.4; }
            25% { transform: translateY(-40px) rotate(3deg); opacity: 0.7; }
            50% { transform: translateY(-80px) rotate(-3deg); opacity: 0.3; }
            75% { transform: translateY(-40px) rotate(2deg); opacity: 0.6; }
        }

        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            color: rgba(167, 139, 250, 0.9);
            font-size: 12px;
            font-family: 'Sporting Grotesque', 'Arial', sans-serif;
            font-weight: normal;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.8);
            z-index: 100;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(167, 139, 250, 0.5);
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.3);
        }



    </style>
</head>
<body>
    <div class="psychedelic-coffee-animation">
        <div class="wave-layer wave-1"></div>
        <div class="wave-layer wave-2"></div>
        <div class="wave-layer wave-3"></div>
        <div class="wave-layer wave-4"></div>
        
        <div class="floating-bean bean-1 bean-close"></div>
        <div class="floating-bean bean-2 bean-far"></div>
        <div class="floating-bean bean-3 bean-medium"></div>
        <div class="floating-bean bean-4 bean-distant"></div>
        <div class="floating-bean bean-5 bean-close"></div>
        <div class="floating-bean bean-6 bean-medium"></div>
        <div class="floating-bean bean-7 bean-far"></div>
        <div class="floating-bean bean-8 bean-distant"></div>
        <div class="floating-bean bean-9 bean-close"></div>
        <div class="floating-bean bean-10 bean-medium"></div>
        <div class="floating-bean bean-11 bean-far"></div>
        <div class="floating-bean bean-12 bean-distant"></div>
        
        <div class="spiral spiral-1"></div>
        <div class="spiral spiral-2"></div>
        <div class="spiral spiral-3"></div>
        
        <div class="coffee-steam steam-1"></div>
        <div class="coffee-steam steam-2"></div>
        <div class="coffee-steam steam-3"></div>
        <div class="coffee-steam steam-4"></div>
        
        <div class="kaleidoscope-ring ring-1"></div>
        <div class="kaleidoscope-ring ring-2"></div>
        <div class="kaleidoscope-ring ring-3"></div>
        
        <div class="pulsing-circle circle-1"></div>
        <div class="pulsing-circle circle-2"></div>
        <div class="pulsing-circle circle-3"></div>
        
        <div class="floating-formula formula-1">Fascinating</div>
        <div class="floating-formula formula-2">Complexity</div>
        <div class="floating-formula formula-3">Brightness</div>
        <div class="floating-formula formula-4">Extraction</div>
        <div class="floating-formula formula-5">Grind size</div>
        <div class="floating-formula formula-6">Terroir</div>
        <div class="floating-formula formula-7">Washed</div>
        <div class="floating-formula formula-8">Light roast</div>
        <div class="floating-formula formula-9">Cupping</div>
        <div class="floating-formula formula-10">V60</div>
        <div class="floating-formula formula-11">Channeling</div>
        <div class="floating-formula formula-12">Floral</div>
        <div class="floating-formula formula-13">Gesha</div>
        <div class="floating-formula formula-14">Ethiopia</div>
        <div class="floating-formula formula-15">Competition</div>
        
    </div>

    <div class="controls">
        <div>üéµ Mikrofon: <span id="micStatus">Av</span></div>
        <div><button onclick="toggleAudio()" style="background: none; border: 1px solid rgba(167, 139, 250, 0.5); color: rgba(167, 139, 250, 0.9); padding: 4px 8px; border-radius: 3px; font-size: 10px;">LYD</button></div>
    </div>

    

    <script>
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'f' || e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            } else if (e.key === 'Escape') {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }
        });

        // Click anywhere to toggle fullscreen
        document.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                toggleFullscreen();
            }
        });

        // James Hoffmann inspired coffee vocabulary
        const coffeeWords = [
            ['Fascinating', 'Extraordinary', 'Rather wonderful', 'Quite remarkable', 'Absolutely stunning', 'Phenomenal', 'Delicious', 'Beautiful'],
            ['Complexity', 'Clarity', 'Balance', 'Structure', 'Elegance', 'Refinement', 'Sophistication', 'Harmony'],
            ['Brightness', 'Acidity', 'Sweetness', 'Body', 'Texture', 'Mouthfeel', 'Finish', 'Lingering'],
            ['Extraction', 'Uniformity', 'Consistency', 'Precision', 'Technique', 'Method', 'Approach', 'Craft'],
            ['Grind size', 'Water temperature', 'Brew ratio', 'Contact time', 'Agitation', 'Turbulence', 'Flow rate', 'Pressure'],
            ['Terroir', 'Processing', 'Varietal', 'Origin', 'Altitude', 'Climate', 'Soil', 'Harvest'],
            ['Washed', 'Natural', 'Honey', 'Anaerobic', 'Fermentation', 'Carbonic maceration', 'Extended fermentation', 'Controlled atmosphere'],
            ['Light roast', 'Medium roast', 'Development', 'First crack', 'Maillard reaction', 'Caramelization', 'Roast profile', 'Drop temperature'],
            ['Cupping', 'Slurping', 'Aromatics', 'Fragrance', 'Aftertaste', 'Retronasal', 'Olfactory', 'Sensory analysis'],
            ['V60', 'Chemex', 'AeroPress', 'French press', 'Espresso', 'Pour over', 'Immersion', 'Percolation'],
            ['Channeling', 'Over-extraction', 'Under-extraction', 'Astringency', 'Bitterness', 'Sourness', 'Drying', 'Harsh'],
            ['Floral', 'Fruity', 'Citrus', 'Stone fruit', 'Berry', 'Tropical', 'Chocolate', 'Caramel'],
            ['Gesha', 'Bourbon', 'Typica', 'Caturra', 'Pacamara', 'SL28', 'SL34', 'Mundo Novo'],
            ['Ethiopia', 'Colombia', 'Jamaica', 'Yemen', 'Panama', 'Kenya', 'Guatemala', 'Costa Rica'],
            ['Competition', 'Championship', 'Barista', 'Roaster', 'Producer', 'Farm', 'Cooperative', 'Direct trade'],
            ['hallvar.no', 'koffeinvinduet']
        ];

        // Audio variables
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let audioEnabled = false;
        let audioLevel = 0;

        // Beat detection variables
        let beatHistory = [];
        let lastBeat = 0;
        let beatThreshold = 0.3;
        let beatDecay = 0.98;
        let beatSensitivity = 1.5;
        let currentBPM = 120;
        let beatPulse = 0;
        let lastBeatTime = 0;
        let bpmHistory = [];

        // Audio setup
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false 
                    } 
                });
                
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                
                microphone.connect(analyser);
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                audioEnabled = true;
                document.getElementById('micStatus').textContent = 'P√•';
                
            } catch (err) {
                console.log('Mikrofon ikke tilgjengelig:', err);
                document.getElementById('micStatus').textContent = 'Feil';
            }
        }

        function getAudioLevel() {
            if (!audioEnabled || !analyser) return 0;
            
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            
            const average = sum / dataArray.length;
            return Math.min(average / 128, 1);
        }

        function detectBeat() {
            if (!audioEnabled || !analyser) return false;
            
            analyser.getByteFrequencyData(dataArray);
            
            // Focus on bass frequencies for beat detection (20-200Hz)
            let bassSum = 0;
            const bassEnd = Math.floor((200 / (audioContext.sampleRate / 2)) * dataArray.length);
            
            for (let i = 1; i < bassEnd; i++) {
                bassSum += dataArray[i];
            }
            
            const bassAverage = bassSum / bassEnd;
            const normalizedBass = bassAverage / 128;
            
            // Add to beat history
            beatHistory.push(normalizedBass);
            if (beatHistory.length > 43) { // ~0.7 seconds at 60fps
                beatHistory.shift();
            }
            
            // Calculate moving average
            const average = beatHistory.reduce((a, b) => a + b, 0) / beatHistory.length;
            
            // Adaptive threshold
            beatThreshold = average * beatSensitivity;
            
            // Detect beat
            const now = performance.now();
            const isNewBeat = normalizedBass > beatThreshold && 
                            normalizedBass > lastBeat * 1.1 && 
                            now - lastBeatTime > 300; // Minimum 300ms between beats
            
            if (isNewBeat) {
                // Calculate BPM
                if (lastBeatTime > 0) {
                    const timeDiff = now - lastBeatTime;
                    const newBPM = 60000 / timeDiff;
                    if (newBPM > 60 && newBPM < 200) {
                        bpmHistory.push(newBPM);
                        if (bpmHistory.length > 8) {
                            bpmHistory.shift();
                        }
                        currentBPM = bpmHistory.reduce((a, b) => a + b, 0) / bpmHistory.length;
                    }
                }
                lastBeatTime = now;
                beatPulse = 1.0;
            }
            
            // Decay beat pulse
            beatPulse *= beatDecay;
            lastBeat = normalizedBass;
            
            return isNewBeat;
        }

        function toggleAudio() {
            if (audioEnabled) {
                if (microphone) {
                    microphone.disconnect();
                }
                audioEnabled = false;
                document.getElementById('micStatus').textContent = 'Av';
            } else {
                initAudio();
            }
        }

        // Animation loop for audio reactivity
        function updateAudioVisuals() {
            // Get audio level and detect beats
            audioLevel = getAudioLevel();
            detectBeat();
            
            // Make kaleidoscope rings pulse dramatically with beat
            const rings = document.querySelectorAll('.kaleidoscope-ring');
            rings.forEach((ring, index) => {
                const vibrateIntensity = beatPulse * (15 + index * 8);
                const vibrateX = (Math.random() - 0.5) * vibrateIntensity;
                const vibrateY = (Math.random() - 0.5) * vibrateIntensity;
                
                // Dramatic scaling based on beat
                const dramaticScale = 1 + beatPulse * (0.3 + index * 0.1); // 30-50% scaling
                
                // Intense brightness and glow
                const glowIntensity = 1 + beatPulse * (2 + index * 0.5); // 2-3.5x brightness
                
                // Multiple layers of pulsing glow - VERY dramatic
                const baseGlow = 25 + index * 10; // Base glow size per ring
                const pulseGlow1 = baseGlow + beatPulse * (60 + index * 30); // Inner glow
                const pulseGlow2 = baseGlow * 2 + beatPulse * (120 + index * 40); // Outer glow
                const pulseGlow3 = baseGlow * 3 + beatPulse * (180 + index * 60); // Mega outer glow
                
                // Pulsing glow intensity
                const glowAlpha1 = 0.8 + beatPulse * 0.2;
                const glowAlpha2 = 0.6 + beatPulse * 0.4;
                const glowAlpha3 = 0.3 + beatPulse * 0.7; // This one pulses the most
                
                // Opacity pulse for extra drama
                const opacityPulse = 0.7 + beatPulse * 0.3;
                
                ring.style.transform = `translate(${vibrateX}px, ${vibrateY}px) scale(${dramaticScale})`;
                ring.style.filter = `brightness(${glowIntensity}) drop-shadow(0 0 ${pulseGlow1}px rgba(167, 139, 250, ${glowAlpha1})) drop-shadow(0 0 ${pulseGlow2}px rgba(102, 126, 234, ${glowAlpha2})) drop-shadow(0 0 ${pulseGlow3}px rgba(118, 75, 162, ${glowAlpha3}))`;
                ring.style.opacity = opacityPulse;
                
                // Make border width pulse too
                const borderPulse = 3 + beatPulse * 5; // 3-8px border width
                ring.style.borderWidth = `${borderPulse}px`;
            });
            
            // Make coffee beans pulse with beat - flat design
            const beans = document.querySelectorAll('.floating-bean');
            beans.forEach((bean, index) => {
                const glowIntensity = 1 + beatPulse * 2;
                const scaleIntensity = 1 + beatPulse * 0.15;
                const shadowBlur = 30 + beatPulse * 40;
                
                bean.style.filter = `brightness(${glowIntensity})`;
                bean.style.transform = `scale(${scaleIntensity})`;
                bean.style.boxShadow = `0 0 ${shadowBlur}px rgba(167, 139, 250, ${0.6 + beatPulse * 0.4})`;
            });
            
            // Make steam pulse with audio level
            const steams = document.querySelectorAll('.coffee-steam');
            steams.forEach((steam, index) => {
                const intensity = 1 + audioLevel * 1.5;
                steam.style.filter = `blur(3px) brightness(${intensity})`;
                steam.style.transform = `scale(${1 + audioLevel * 0.2})`;
            });
            
            // Make pulsing circles react more to beat
            const circles = document.querySelectorAll('.pulsing-circle');
            circles.forEach((circle, index) => {
                const pulseIntensity = 1 + beatPulse * 0.3;
                circle.style.transform = `scale(${pulseIntensity})`;
                circle.style.filter = `brightness(${1 + beatPulse * 0.8})`;
            });
            
            
            requestAnimationFrame(updateAudioVisuals);
        }
        
        // Start audio visuals
        updateAudioVisuals();

        // Create flat array of all words for completely random selection
        const allCoffeeWords = coffeeWords.flat();
        
        // Track currently visible words to prevent duplicates
        let currentlyVisibleWords = new Set();
        
        // Async word changing with complete fade and position changes
        function changeWordAsync(formula) {
            const randomDelay = Math.random() * 6000 + 4000; // 4-10 seconds - longer pauses
            
            setTimeout(() => {
                // Remove current word from visible set
                const currentWord = formula.textContent;
                currentlyVisibleWords.delete(currentWord);
                
                // Fade out completely with rotation
                formula.style.opacity = '0';
                const exitRotation = (Math.random() - 0.5) * 40; // More dramatic exit rotation
                formula.style.transform = `rotate(${exitRotation}deg) scale(0.8)`; // Also scale down
                
                setTimeout(() => {
                    // Move to completely new position while invisible
                    const newTop = Math.random() * 80 + 10; // 10-90% of screen height
                    const newLeft = Math.random() * 80 + 10; // 10-90% of screen width
                    
                    // Apply new position
                    formula.style.top = `${newTop}%`;
                    formula.style.left = `${newLeft}%`;
                    formula.style.right = 'auto'; // Clear right positioning
                    formula.style.bottom = 'auto'; // Clear bottom positioning
                    
                    // Find a word that's not currently visible
                    let randomWord;
                    let attempts = 0;
                    do {
                        randomWord = allCoffeeWords[Math.floor(Math.random() * allCoffeeWords.length)];
                        attempts++;
                    } while (currentlyVisibleWords.has(randomWord) && attempts < 50);
                    
                    // Add new word to visible set
                    currentlyVisibleWords.add(randomWord);
                    formula.textContent = randomWord;
                    
                    // Random entry rotation and scale
                    const entryRotation = (Math.random() - 0.5) * 25; // -12.5 to +12.5 degrees
                    const entryScale = 0.9 + Math.random() * 0.4; // 0.9 to 1.3 scale
                    formula.style.transform = `rotate(${entryRotation}deg) scale(${entryScale})`;
                    
                    // Wait a bit more then fade in
                    setTimeout(() => {
                        formula.style.opacity = '0.6';
                    }, 200); // Small delay before fade in
                    
                    // Schedule next change
                    changeWordAsync(formula);
                }, 2500); // Longer invisible period - 2.5s
                
            }, randomDelay);
        }
        
        // Continuous subtle rotation for all formulas
        function addContinuousRotation() {
            const formulas = document.querySelectorAll('.floating-formula');
            formulas.forEach((formula) => {
                setInterval(() => {
                    if (parseFloat(formula.style.opacity) > 0.5) { // Only rotate when visible
                        const subtleRotation = (Math.random() - 0.5) * 8; // -4 to +4 degrees
                        const currentTransform = formula.style.transform || '';
                        const rotationMatch = currentTransform.match(/rotate\(([^)]+)\)/);
                        const currentRotation = rotationMatch ? parseFloat(rotationMatch[1]) : 0;
                        const newRotation = currentRotation + subtleRotation * 0.1;
                        formula.style.transform = `rotate(${newRotation}deg)`;
                    }
                }, 3000 + Math.random() * 4000); // Every 3-7 seconds
            });
        }
        
        // Start async word changing for each formula - completely independent
        const formulas = document.querySelectorAll('.floating-formula');
        formulas.forEach((formula, index) => {
            // Initialize visible words set with starting words
            currentlyVisibleWords.add(formula.textContent);
            
            // Give each word a completely different lifecycle
            const initialDelay = Math.random() * 12000; // 0-12 seconds initial delay
            
            setTimeout(() => {
                changeWordAsync(formula);
            }, initialDelay);
        });
        
        // Start continuous rotation
        addContinuousRotation();

        // Regular display of special words every 25 seconds
        const specialWords = ['hallvar.no', 'koffeinvinduet'];
        let specialWordIndex = 0;

        function showSpecialWord() {
            // Find a random word element that's currently invisible or has low opacity
            const allFormulas = document.querySelectorAll('.floating-formula');
            const availableFormulas = Array.from(allFormulas).filter(formula => 
                parseFloat(getComputedStyle(formula).opacity) < 0.3
            );
            
            let targetFormula;
            if (availableFormulas.length > 0) {
                // Use an invisible/faded word
                targetFormula = availableFormulas[Math.floor(Math.random() * availableFormulas.length)];
            } else {
                // If all words are visible, pick a random one
                targetFormula = allFormulas[Math.floor(Math.random() * allFormulas.length)];
            }

            if (targetFormula) {
                // Remove current word from visible set
                currentlyVisibleWords.delete(targetFormula.textContent);
                
                // Fade out quickly
                targetFormula.style.opacity = '0';
                
                setTimeout(() => {
                    // Move to new position
                    const newTop = Math.random() * 80 + 10;
                    const newLeft = Math.random() * 80 + 10;
                    
                    targetFormula.style.top = `${newTop}%`;
                    targetFormula.style.left = `${newLeft}%`;
                    targetFormula.style.right = 'auto';
                    targetFormula.style.bottom = 'auto';
                    
                    // Set special word
                    const specialWord = specialWords[specialWordIndex];
                    specialWordIndex = (specialWordIndex + 1) % specialWords.length;
                    
                    currentlyVisibleWords.add(specialWord);
                    targetFormula.textContent = specialWord;
                    
                    // Special styling for these words - slightly larger and brighter
                    const rotation = (Math.random() - 0.5) * 20;
                    const scale = 1.1 + Math.random() * 0.3; // 1.1 to 1.4 - larger than normal
                    targetFormula.style.transform = `rotate(${rotation}deg) scale(${scale})`;
                    targetFormula.style.opacity = '0.8'; // Slightly more visible
                    
                    // Make them glow more
                    targetFormula.style.textShadow = '0 0 15px rgba(167, 139, 250, 0.8), 0 0 30px rgba(102, 126, 234, 0.6)';
                    
                    // Return to normal after showing for a while
                    setTimeout(() => {
                        targetFormula.style.textShadow = '0 0 10px rgba(167, 139, 250, 0.3), 0 0 20px rgba(102, 126, 234, 0.2)';
                    }, 8000); // Extra glow for 8 seconds
                    
                }, 800); // Quick fade out
            }
        }

        // Show special words every 25 seconds
        setInterval(showSpecialWord, 25000);

        // Show first special word after 10 seconds
        setTimeout(showSpecialWord, 10000);
    </script>
</body>
</html>